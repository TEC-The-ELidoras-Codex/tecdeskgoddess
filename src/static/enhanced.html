<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEC Life & Finance Digital Companion - Enhanced with Persona System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <link rel="stylesheet" href="assets/css/persona_ui.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #16213e 100%); color: #e0e6ed; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .glassmorphism { background: rgba(255,255,255,0.05); backdrop-filter: blur(20px); border:1px solid rgba(255,255,255,0.1); border-radius:16px; }
        
        /* Header */
        header { padding: 20px; text-align: center; }
        h1 { font-size: 2.5rem; font-weight: 800; background: linear-gradient(90deg, #7b2ff7, #f107a3); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        p { margin: 10px 0; }
        
        /* Main Container */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; display: flex; flex-direction: column; min-height: calc(100vh - 40px); }
        
        /* Status Dashboard */
        .status-dashboard { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .status-card { padding: 20px; border-radius: 12px; }
        .status-online { color: #10b981; }
        .status-offline { color: #ef4444; }
        .status-connecting { color: #f59e0b; }
        
        /* Persona Status Bar */
        .persona-status-bar { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 15px 20px; 
            margin-bottom: 20px; 
            background: rgba(255,255,255,0.1); 
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .persona-info { display: flex; align-items: center; gap: 15px; }
        .persona-avatar { width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #7b2ff7, #f107a3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
        .persona-details h3 { margin: 0; font-size: 1.1rem; color: #f59e0b; }
        .persona-details p { margin: 0; font-size: 0.9rem; color: #9ca3af; }
        .persona-controls { display: flex; gap: 10px; }
        .persona-btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; transition: all 0.3s; }
        .persona-btn-primary { background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%); color: white; }
        .persona-btn-secondary { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); }
        
        /* Chat Interface */
        .chat-interface { flex: 1; display: flex; flex-direction: column; }
        .chat-container { flex: 1; overflow-y: auto; padding: 20px; border-radius: 12px; background: rgba(255, 255, 255, 0.1); min-height: 400px; max-height: 600px; }
        .message { margin-bottom: 15px; padding: 15px; border-radius: 12px; max-width: 80%; }
        .user-message { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; margin-left: auto; }
        .ai-message { background: linear-gradient(135deg, #374151 0%, #4b5563 100%); color: white; margin-right: auto; }
        .message-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 0.9rem; opacity: 0.8; }
        .message-content { line-height: 1.6; }
        
        /* Enhanced Input Area */
        .input-area { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .input-controls { display: flex; gap: 10px; }
        .input-controls input { flex: 1; padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white; }
        .input-controls button { padding: 15px 25px; border-radius: 12px; background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%); color: white; border: none; cursor: pointer; transition: all 0.3s; }
        .input-controls button:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3); }
        
        /* AI Settings Bar */
        .ai-settings-bar { 
            display: flex; 
            align-items: center; 
            gap: 20px; 
            padding: 15px 20px; 
            background: rgba(255,255,255,0.05); 
            border-radius: 12px; 
            font-size: 0.9rem;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
            z-index: 10;
        }

        /* Character Customization Button */
        .character-btn {
            padding: 8px 15px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
            margin-left: auto;
        }

        .character-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
        }

        .ai-setting { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            position: relative;
        }
        .ai-setting label { 
            color: #e0e6ed; 
            min-width: 90px; 
            font-weight: 500;
            cursor: help;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .ai-setting input[type="range"] { 
            width: 120px; 
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            outline: none;
            cursor: pointer;
        }
        .ai-setting input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(124, 58, 237, 0.3);
        }
        .ai-setting select { 
            padding: 8px 12px; 
            border-radius: 8px; 
            background: rgba(255,255,255,0.1); 
            color: white; 
            border: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .ai-setting select:hover {
            background: rgba(255,255,255,0.15);
            border-color: rgba(124, 58, 237, 0.5);
        }
        .ai-setting select:focus {
            outline: none;
            border-color: #7c3aed;
            box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.2);
        }
        
        /* Custom Tooltip System */
        .tooltip-container {
            position: relative;
            display: inline-block;
        }
        .custom-tooltip {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 0.85rem;
            line-height: 1.4;
            white-space: nowrap;
            max-width: 300px;
            white-space: normal;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        .custom-tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.9) transparent transparent transparent;
        }
        .tooltip-container:hover .custom-tooltip {
            visibility: visible;
            opacity: 1;
            transform: translateX(-50%) translateY(-5px);
        }
        
        /* Creativity Slider Value Display */
        #creativityValue {
            min-width: 40px;
            text-align: center;
            font-weight: 600;
            color: #7c3aed;
        }
        
        /* Settings Animation */
        .ai-setting {
            transition: transform 0.2s ease;
        }
        .ai-setting:hover {
            transform: translateY(-1px);
        }
        
        /* Background Layer Control */
        .ai-settings-bar {
            position: relative;
            z-index: 100; /* Ensure it's above background elements */
        }
        
        /* Enhanced Glassmorphism Effect */
        .glassmorphism {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px); /* Safari support */
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        /* Settings Icons */
        .ai-setting i {
            color: #7c3aed;
            text-shadow: 0 0 10px rgba(124, 58, 237, 0.3);
        }
        
        /* Focus states for accessibility */
        .ai-setting input:focus,
        .ai-setting select:focus {
            outline: 2px solid #7c3aed;
            outline-offset: 2px;
        }
        
        /* Hover effects for better UX */
        .ai-setting input[type="range"]:hover {
            cursor: pointer;
        }
        
        .ai-setting label:hover {
            color: #ffffff;
            transition: color 0.2s ease;
        }
        
        /* Quick Actions */
        .quick-actions { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 15px; }
        .quick-actions button { padding: 12px; border-radius: 8px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); cursor: pointer; transition: all 0.3s; color: white; }
        .quick-actions button:hover { background: rgba(255, 255, 255, 0.2); transform: translateY(-2px); }
        
        /* Feature Panels */
        .feature-panels { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
        .feature-card { padding: 20px; border-radius: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); }
        .feature-card h3 { margin-bottom: 15px; color: #f59e0b; }
        
        /* Character Selection */
        .character-selection { display: flex; gap: 15px; margin-bottom: 15px; }
        .character-card { 
            padding: 15px; 
            border-radius: 12px; 
            background: rgba(255,255,255,0.1); 
            border: 2px solid transparent; 
            cursor: pointer; 
            transition: all 0.3s;
            text-align: center;
            min-width: 120px;
        }
        .character-card:hover { border-color: rgba(124, 58, 237, 0.5); }
        .character-card.active { border-color: #7c3aed; background: rgba(124, 58, 237, 0.2); }
        .character-card img { width: 60px; height: 60px; border-radius: 50%; margin-bottom: 10px; }
        .character-card h4 { margin: 0; font-size: 1rem; color: #f59e0b; }
        .character-card p { margin: 5px 0 0 0; font-size: 0.8rem; color: #9ca3af; }
        
        /* Enhanced Mobile Optimization */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            
            /* Header adjustments */
            header { padding: 15px 10px; }
            h1 { font-size: 1.8rem; }
            
            /* Status dashboard mobile */
            .status-dashboard { 
                grid-template-columns: repeat(2, 1fr); 
                gap: 10px; 
                margin-bottom: 15px; 
            }
            .status-card { padding: 15px; }
            
            /* Persona status bar mobile */
            .persona-status-bar { 
                flex-direction: column; 
                gap: 15px; 
                padding: 15px; 
            }
            .persona-info { 
                flex-direction: column; 
                text-align: center; 
                gap: 10px; 
            }
            .persona-controls { 
                flex-direction: column; 
                gap: 10px; 
            }
            .persona-btn { 
                padding: 12px 20px; 
                font-size: 0.9rem; 
            }
            
            /* Character selection mobile */
            .character-selection { 
                display: grid; 
                grid-template-columns: repeat(2, 1fr); 
                gap: 10px; 
                margin-bottom: 15px; 
            }
            .character-card { 
                padding: 10px; 
                min-width: auto; 
            }
            .character-card h4 { font-size: 0.9rem; }
            .character-card p { font-size: 0.75rem; }
            
            /* AI settings mobile */
            .ai-settings-bar { 
                flex-wrap: wrap;
                gap: 15px; 
                padding: 15px; 
            }
            .ai-setting { 
                flex: 1;
                min-width: 45%;
                justify-content: space-between; 
                flex-wrap: wrap; 
                gap: 8px; 
            }
            .ai-setting label { 
                min-width: auto; 
                font-size: 0.85rem; 
            }
            .ai-setting input[type="range"] { 
                width: 100px; 
            }
            
            /* Mobile tooltip adjustments */
            .custom-tooltip {
                bottom: auto;
                top: 125%;
                max-width: 250px;
                font-size: 0.8rem;
                padding: 10px 12px;
            }
            .custom-tooltip::after {
                top: auto;
                bottom: 100%;
                border-color: transparent transparent rgba(0, 0, 0, 0.9) transparent;
            }
            .ai-setting select { 
                min-width: 120px; 
            }
            
            /* Chat interface mobile */
            .chat-container { 
                max-height: 400px; 
                padding: 15px; 
            }
            .message { 
                max-width: 95%; 
                padding: 12px; 
                font-size: 0.9rem; 
            }
            .message-header { 
                font-size: 0.8rem; 
            }
            
            /* Input area mobile */
            .input-controls { 
                flex-direction: column; 
                gap: 10px; 
            }
            .input-controls input { 
                padding: 12px; 
                font-size: 1rem; 
            }
            .input-controls button { 
                padding: 12px 20px; 
                font-size: 1rem; 
            }
            
            /* Quick actions mobile */
            .quick-actions { 
                grid-template-columns: repeat(2, 1fr); 
                gap: 8px; 
                margin-top: 10px; 
            }
            .quick-actions button { 
                padding: 10px 8px; 
                font-size: 0.85rem; 
            }
            
            /* Feature panels mobile */
            .feature-panels { 
                grid-template-columns: 1fr; 
                gap: 15px; 
                margin-top: 15px; 
            }
            .feature-card { 
                padding: 15px; 
            }
        }
        
        /* Tablet optimization */
        @media (min-width: 769px) and (max-width: 1024px) {
            .container { max-width: 95%; }
            
            .status-dashboard { 
                grid-template-columns: repeat(2, 1fr); 
            }
            
            .character-selection { 
                justify-content: center; 
                flex-wrap: wrap; 
            }
            
            .ai-settings-bar { 
                flex-wrap: wrap; 
                gap: 15px; 
            }
            
            .feature-panels { 
                grid-template-columns: repeat(2, 1fr); 
            }
        }
        
        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            .character-card { 
                padding: 20px; 
                min-height: 100px; 
            }
            
            .persona-btn { 
                padding: 15px 20px; 
                font-size: 1rem; 
            }
            
            .quick-actions button { 
                padding: 15px 12px; 
                min-height: 50px; 
            }
            
            .input-controls button { 
                min-height: 50px; 
            }
        }
        
        /* Animations */
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeInUp { animation: fadeInUp 0.5s ease-out; }
        
        /* Audio Controls */
        .audio-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: 10px;
        }
        .audio-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: rgba(255,255,255,0.1);
            color: white;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
        }
        .audio-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        .audio-btn.active {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        .audio-btn.recording {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            animation: pulse 1s infinite;
        }
        
        /* Voice Input */
        .voice-input-container {
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .voice-btn {
            padding: 15px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
            min-width: 50px;
            height: 50px;
        }
        .voice-btn:hover {
            transform: scale(1.1);
        }
        .voice-btn.recording {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            animation: pulse 1s infinite;
        }
        
        /* Audio Status */
        .audio-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            font-size: 0.85rem;
            color: #9ca3af;
        }
        .audio-status.speaking {
            color: #10b981;
        }
        .audio-status.listening {
            color: #3b82f6;
        }
        
        /* Audio Visualizer */
        .audio-visualizer {
            display: flex;
            align-items: center;
            gap: 2px;
            height: 20px;
            margin-left: 10px;
        }
        .audio-bar {
            width: 3px;
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 1px;
            animation: audioVisualize 0.5s infinite alternate;
        }
        .audio-bar:nth-child(1) { animation-delay: 0s; }
        .audio-bar:nth-child(2) { animation-delay: 0.1s; }
        .audio-bar:nth-child(3) { animation-delay: 0.2s; }
        .audio-bar:nth-child(4) { animation-delay: 0.3s; }
        .audio-bar:nth-child(5) { animation-delay: 0.4s; }
        
        @keyframes audioVisualize {
            0% { height: 4px; }
            100% { height: 20px; }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* Typing indicator */
        .typing-indicator { opacity: 0.7; }
        .typing-dots { display: flex; gap: 4px; padding: 10px 0; }
        .typing-dots span { 
            width: 8px; 
            height: 8px; 
            border-radius: 50%; 
            background: #9ca3af; 
            animation: typing 1.4s infinite; 
        }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { opacity: 0.3; transform: translateY(0); }
            30% { opacity: 1; transform: translateY(-10px); }
        }

        /* Character Avatar Animations */
        @keyframes avatarGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(123, 47, 247, 0.5); }
            50% { box-shadow: 0 0 30px rgba(123, 47, 247, 0.8), 0 0 40px rgba(241, 7, 163, 0.6); }
        }

        @keyframes floatAnimation {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes shimmer {
            0% { background-position: -200px 0; }
            100% { background-position: 200px 0; }
        }

        @keyframes particleFloat {
            0%, 100% { transform: translateY(0) rotate(0deg); opacity: 0.3; }
            50% { transform: translateY(-20px) rotate(180deg); opacity: 1; }
        }

        /* Enhanced Avatar Styles */
        .persona-avatar {
            position: relative;
            animation: avatarGlow 3s ease-in-out infinite;
            transition: all 0.5s ease;
            overflow: hidden;
        }

        .persona-avatar::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 2s infinite;
            transform: rotate(45deg);
        }

        .persona-avatar.active {
            animation: avatarGlow 1.5s ease-in-out infinite, floatAnimation 2s ease-in-out infinite;
            transform: scale(1.1);
        }

        /* Character-specific avatar styles */
        .persona-avatar.polkin {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed, #6d28d9);
            border: 2px solid #a855f7;
        }

        .persona-avatar.mynx {
            background: linear-gradient(135deg, #06b6d4, #0891b2, #0e7490);
            border: 2px solid #22d3ee;
        }

        .persona-avatar.kaelen {
            background: linear-gradient(135deg, #f59e0b, #d97706, #b45309);
            border: 2px solid #fbbf24;
        }

        .persona-avatar.default {
            background: linear-gradient(135deg, #7b2ff7, #f107a3, #c026d3);
            border: 2px solid #e879f9;
        }

        /* Character Card Enhancements */
        .character-card {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .character-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s ease;
        }

        .character-card:hover::before {
            left: 100%;
        }

        .character-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(123, 47, 247, 0.3);
        }

        .character-card.active {
            border: 2px solid #7c3aed;
            background: rgba(124, 58, 237, 0.1);
            transform: scale(1.05);
        }

        .character-card .character-card-img {
            transition: all 0.3s ease;
        }

        .character-card:hover .character-card-img {
            transform: scale(1.1) rotate(5deg);
        }

        /* Character Card Images */
        .character-card-img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .character-card-img::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 2s infinite;
            transform: rotate(45deg);
        }

        .character-card-img.default {
            background: linear-gradient(135deg, #7b2ff7, #f107a3, #c026d3);
            border: 2px solid #e879f9;
        }

        .character-card-img.polkin {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed, #6d28d9);
            border: 2px solid #a855f7;
        }

        .character-card-img.mynx {
            background: linear-gradient(135deg, #06b6d4, #0891b2, #0e7490);
            border: 2px solid #22d3ee;
        }

        .character-card-img.kaelen {
            background: linear-gradient(135deg, #f59e0b, #d97706, #b45309);
            border: 2px solid #fbbf24;
        }

        /* Floating Particles */
        .floating-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(123, 47, 247, 0.6);
            border-radius: 50%;
            animation: particleFloat 6s ease-in-out infinite;
        }

        .particle:nth-child(2n) {
            background: rgba(241, 7, 163, 0.6);
            animation-delay: -2s;
        }

        .particle:nth-child(3n) {
            background: rgba(124, 58, 237, 0.6);
            animation-delay: -4s;
        }

        /* Theme Transitions */
        .theme-transition {
            transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        /* Polkin Theme */
        .theme-polkin {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #4338ca 100%);
        }

        .theme-polkin .glassmorphism {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        /* Mynx Theme */
        .theme-mynx {
            background: linear-gradient(135deg, #0c4a6e 0%, #075985 50%, #0369a1 100%);
        }

        .theme-mynx .glassmorphism {
            background: rgba(6, 182, 212, 0.1);
            border: 1px solid rgba(6, 182, 212, 0.2);
        }

        /* Kaelen Theme */
        .theme-kaelen {
            background: linear-gradient(135deg, #78350f 0%, #92400e 50%, #b45309 100%);
        }

        .theme-kaelen .glassmorphism {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        /* Enhanced Message Bubbles */
        .message-bubble {
            position: relative;
            overflow: hidden;
        }

        .message-bubble::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
            transition: left 0.8s ease;
        }

        .message-bubble.sending::before {
            left: 100%;
        }

        /* Status Card Enhancements */
        .status-card {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .status-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #7b2ff7, #f107a3);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
        }

        .status-card.active::after {
            transform: scaleX(1);
        }

        .status-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(123, 47, 247, 0.2);
        }
        
        /* Hidden class */
        .hidden { display: none !important; }
        
        /* Character Avatar Section Layout */
        .character-avatar-section { 
            display: flex; 
            gap: 20px; 
            align-items: center; 
            margin-bottom: 20px; 
        }
        .avatar-display-container { 
            flex-shrink: 0; 
        }
        .character-selection { 
            flex: 1; 
        }
        
        /* Avatar Component Styles */
        .avatar-container {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
        }

        .avatar-circle {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            z-index: 2;
        }

        .avatar-face {
            font-size: 2.5rem;
            transition: all 0.3s ease;
            z-index: 3;
            position: relative;
        }

        .avatar-eyes {
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 4;
        }

        .eye {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: white;
            position: relative;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
            animation: eyeBlink 4s ease-in-out infinite;
        }

        .eye::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: #333;
            transition: all 0.2s ease;
        }

        .avatar-aura {
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            border-radius: 50%;
            opacity: 0.7;
            z-index: 1;
            animation: auraFloat 3s ease-in-out infinite;
        }

        .avatar-aura::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            background: inherit;
            filter: blur(8px);
        }

        .avatar-particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .particle {
            position: absolute;
            width: 3px;
            height: 3px;
            border-radius: 50%;
            opacity: 0.8;
        }

        /* Character-Specific Avatar Styles */
        .avatar-polkin {
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 50%, #7c3aed 100%);
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.6);
        }

        .avatar-polkin .avatar-aura {
            background: radial-gradient(circle, rgba(139, 92, 246, 0.3) 0%, transparent 70%);
        }

        .avatar-mynx {
            background: linear-gradient(135deg, #06b6d4 0%, #22d3ee 50%, #0891b2 100%);
            box-shadow: 0 0 30px rgba(34, 211, 238, 0.6);
        }

        .avatar-mynx .avatar-aura {
            background: radial-gradient(circle, rgba(34, 211, 238, 0.3) 0%, transparent 70%);
        }

        .avatar-kaelen {
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 50%, #d97706 100%);
            box-shadow: 0 0 30px rgba(251, 191, 36, 0.6);
        }

        .avatar-kaelen .avatar-aura {
            background: radial-gradient(circle, rgba(251, 191, 36, 0.3) 0%, transparent 70%);
        }

        /* Avatar Animation States */
        .avatar-idle {
            animation: idleBreathing 4s ease-in-out infinite;
        }

        .avatar-speaking {
            animation: speakingPulse 0.5s ease-in-out infinite alternate;
        }

        .avatar-thinking {
            animation: thinkingGlow 2s ease-in-out infinite;
        }

        .avatar-excited {
            animation: excitedBounce 0.8s ease-in-out infinite;
        }

        .avatar-wise {
            animation: wiseFloat 6s ease-in-out infinite;
        }

        /* Emotion-Specific Eye States */
        .emotion-joy .eye::after {
            background: #fbbf24;
            box-shadow: 0 0 5px rgba(251, 191, 36, 0.8);
        }

        .emotion-curiosity .eye::after {
            background: #22d3ee;
            box-shadow: 0 0 5px rgba(34, 211, 238, 0.8);
            animation: curious 1s ease-in-out infinite;
        }

        .emotion-wisdom .eye::after {
            background: #8b5cf6;
            box-shadow: 0 0 5px rgba(139, 92, 246, 0.8);
            width: 6px;
            height: 6px;
        }

        .emotion-excitement .eye::after {
            background: #ef4444;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.8);
            animation: excited 0.3s ease-in-out infinite;
        }

        .bond-level {
            position: absolute;
            top: -15px;
            right: -15px;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10b981, #059669);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
            z-index: 5;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
        }

        .memory-flash {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 50%);
            opacity: 0;
            z-index: 6;
            animation: memoryFlash 1s ease-out;
        }

        /* Avatar Keyframe Animations */
        @keyframes idleBreathing {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes speakingPulse {
            0% { transform: scale(1); filter: brightness(1); }
            100% { transform: scale(1.1); filter: brightness(1.2); }
        }

        @keyframes thinkingGlow {
            0%, 100% { box-shadow: 0 0 30px var(--glow-color); }
            50% { box-shadow: 0 0 50px var(--glow-color), 0 0 80px var(--glow-color); }
        }

        @keyframes excitedBounce {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-10px) scale(1.1); }
        }

        @keyframes wiseFloat {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-5px) rotate(1deg); }
            75% { transform: translateY(5px) rotate(-1deg); }
        }

        @keyframes auraFloat {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.1) rotate(180deg); }
        }

        @keyframes eyeBlink {
            0%, 90%, 100% { transform: scaleY(1); }
            95% { transform: scaleY(0.1); }
        }

        @keyframes curious {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-30%, -50%) scale(1.2); }
        }

        @keyframes excited {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.5); }
        }

        @keyframes memoryFlash {
            0% { opacity: 0; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
            100% { opacity: 0; transform: scale(1); }
        }

        @keyframes particleFloat {
            0% { opacity: 0; transform: translateY(0) scale(0); }
            10% { opacity: 1; transform: translateY(-10px) scale(1); }
            90% { opacity: 1; transform: translateY(-50px) scale(1); }
            100% { opacity: 0; transform: translateY(-60px) scale(0); }
        }

        /* Mobile Avatar Adjustments */
        @media (max-width: 768px) {
            .character-avatar-section {
                flex-direction: column;
                gap: 15px;
            }
            
            .avatar-container {
                width: 100px;
                height: 100px;
            }
            
            .avatar-face {
                font-size: 2rem;
            }
            
            .bond-level {
                width: 20px;
                height: 20px;
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body class="theme-transition">
    <!-- Floating Particles -->
    <div class="floating-particles">
        <div class="particle" style="left: 10%; top: 20%; animation-delay: 0s;"></div>
        <div class="particle" style="left: 20%; top: 80%; animation-delay: 1s;"></div>
        <div class="particle" style="left: 60%; top: 30%; animation-delay: 2s;"></div>
        <div class="particle" style="left: 80%; top: 70%; animation-delay: 3s;"></div>
        <div class="particle" style="left: 40%; top: 10%; animation-delay: 4s;"></div>
        <div class="particle" style="left: 90%; top: 40%; animation-delay: 5s;"></div>
        <div class="particle" style="left: 30%; top: 90%; animation-delay: 1.5s;"></div>
        <div class="particle" style="left: 70%; top: 60%; animation-delay: 2.5s;"></div>
    </div>

    <div class="container">
        <!-- Header -->
        <header>
            <h1>TEC: BITLyfe Enhanced</h1>
            <p>Your AI-Powered Digital Life & Finance Companion with Persona System</p>
        </header>

        <!-- Status Dashboard -->
        <div class="status-dashboard">
            <div class="status-card glassmorphism">
                <h3><i class="fas fa-robot"></i> AI Status</h3>
                <p id="aiStatus" class="status-connecting">Connecting...</p>
            </div>
            <div class="status-card glassmorphism">
                <h3><i class="fas fa-database"></i> Database</h3>
                <p id="dbStatus" class="status-connecting">Connecting...</p>
            </div>
            <div class="status-card glassmorphism">
                <h3><i class="fas fa-user-circle"></i> Persona</h3>
                <p id="personaStatus" class="status-connecting">Loading...</p>
            </div>
            <div class="status-card glassmorphism">
                <h3><i class="fas fa-brain"></i> Memory</h3>
                <p id="memoryStatus" class="status-connecting">Initializing...</p>
                <small id="memoryDetails" style="display: block; opacity: 0.7; margin-top: 5px;">Bond Level: 1 | Memories: 0</small>
            </div>
            <div class="status-card glassmorphism">
                <h3><i class="fas fa-link"></i> Web3</h3>
                <p id="web3Status" class="status-connecting">Connecting...</p>
            </div>
        </div>

        <!-- Persona Status Bar -->
        <div class="persona-status-bar glassmorphism">
            <div class="persona-info">
                <div class="persona-avatar" id="personaAvatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="persona-details">
                    <h3 id="personaTitle">Default User</h3>
                    <p id="personaSubtitle">Configure your persona to enhance your TEC experience</p>
                </div>
            </div>
            <div class="persona-controls">
                <button id="openPersonaSettings" class="persona-btn persona-btn-primary">
                    <i class="fas fa-cog mr-2"></i>Settings
                </button>
                <button id="enhancedChatToggle" class="persona-btn persona-btn-secondary">
                    <i class="fas fa-brain mr-2"></i>Enhanced Chat
                </button>
                <div class="audio-controls">
                    <button id="ttsToggle" class="audio-btn" title="Toggle Text-to-Speech">
                        <i class="fas fa-volume-up"></i>
                    </button>
                    <button id="voiceToggle" class="audio-btn" title="Toggle Voice Input">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <div class="audio-status" id="audioStatus">
                        <i class="fas fa-volume-off"></i>
                        <span>Audio Off</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Character Selection with Animated Avatar -->
        <div class="character-avatar-section" style="display: flex; gap: 20px; align-items: center; margin-bottom: 20px;">
            <!-- Animated Avatar Display -->
            <div class="avatar-display-container" style="flex-shrink: 0;">
                <div class="avatar-container" id="tecMainAvatar">
                    <!-- Aura Effect -->
                    <div class="avatar-aura"></div>
                    
                    <!-- Particle System -->
                    <div class="avatar-particles" id="mainParticleSystem"></div>
                    
                    <!-- Main Avatar -->
                    <div class="avatar-circle avatar-polkin" id="mainAvatarCircle">
                        <!-- Character Face -->
                        <div class="avatar-face" id="mainAvatarFace">ðŸ”®</div>
                        
                        <!-- Animated Eyes -->
                        <div class="avatar-eyes" id="mainAvatarEyes">
                            <div class="eye"></div>
                            <div class="eye"></div>
                        </div>
                    </div>
                    
                    <!-- Bond Level Indicator -->
                    <div class="bond-level" id="mainBondLevel">1</div>
                    
                    <!-- Memory Flash Effect -->
                    <div class="memory-flash" id="mainMemoryFlash"></div>
                </div>
            </div>
            
            <!-- Character Selection -->
            <div class="character-selection" style="flex: 1;">
                <div class="character-card" data-character="default">
                    <div class="character-card-img default">
                        <i class="fas fa-user"></i>
                    </div>
                    <h4>You</h4>
                    <p>Your persona</p>
                </div>
                <div class="character-card active" data-character="Polkin">
                    <div class="character-card-img polkin">
                        <i class="fas fa-magic"></i>
                    </div>
                    <h4>Polkin</h4>
                    <p>The Mystical Guide</p>
                </div>
                <div class="character-card" data-character="Mynx">
                    <div class="character-card-img mynx">
                        <i class="fas fa-microchip"></i>
                    </div>
                    <h4>Mynx</h4>
                    <p>The Tech Mystic</p>
                </div>
                <div class="character-card" data-character="Kaelen">
                    <div class="character-card-img kaelen">
                        <i class="fas fa-star"></i>
                    </div>
                    <h4>Kaelen</h4>
                    <p>The Cosmic Wanderer</p>
                </div>
            </div>
        </div>

        <!-- AI Settings Bar -->
        <div class="ai-settings-bar glassmorphism">
            <div class="ai-setting">
                <div class="tooltip-container">
                    <label>
                        <i class="fas fa-palette mr-1"></i>Creativity:
                    </label>
                    <div class="custom-tooltip">
                        <strong>Creativity Control</strong><br>
                        Adjusts how creative and imaginative AI responses are:<br>
                        â€¢ <strong>Low (0-30%):</strong> Very logical, predictable, focused responses<br>
                        â€¢ <strong>Medium (40-70%):</strong> Balanced creativity with reliability<br>
                        â€¢ <strong>High (80-100%):</strong> Highly creative, imaginative, unexpected responses
                    </div>
                </div>
                <input type="range" id="creativitySlider" min="0" max="100" value="70">
                <span id="creativityValue">70%</span>
            </div>
            <div class="ai-setting">
                <div class="tooltip-container">
                    <label>
                        <i class="fas fa-brain mr-1"></i>Memory:
                    </label>
                    <div class="custom-tooltip">
                        <strong>Conversation Memory</strong><br>
                        Controls how many previous messages the AI remembers:<br>
                        â€¢ <strong>Short:</strong> Last 10 messages - Fast, efficient<br>
                        â€¢ <strong>Medium:</strong> Last 25 messages - Good balance<br>
                        â€¢ <strong>Long:</strong> Last 50 messages - Full context, slower
                    </div>
                </div>
                <select id="memorySelect">
                    <option value="short">Short (10 msgs)</option>
                    <option value="medium" selected>Medium (25 msgs)</option>
                    <option value="long">Long (50 msgs)</option>
                </select>
            </div>
            <div class="ai-setting">
                <div class="tooltip-container">
                    <label>
                        <i class="fas fa-cog mr-1"></i>Reasoning:
                    </label>
                    <div class="custom-tooltip">
                        <strong>AI Reasoning Depth</strong><br>
                        How deeply the AI thinks before responding:<br>
                        â€¢ <strong>Fast:</strong> Quick responses, basic reasoning<br>
                        â€¢ <strong>Balanced:</strong> Good speed + quality mix<br>
                        â€¢ <strong>Thorough:</strong> Slow but very detailed analysis
                    </div>
                </div>
                <select id="reasoningSelect">
                    <option value="fast">Fast</option>
                    <option value="balanced" selected>Balanced</option>
                    <option value="thorough">Thorough</option>
                </select>
            </div>
            <div class="ai-setting">
                <div class="tooltip-container">
                    <label>
                        <i class="fas fa-robot mr-1"></i>Mode:
                    </label>
                    <div class="custom-tooltip">
                        <strong>AI Interaction Mode</strong><br>
                        The type of AI interaction currently active:<br>
                        â€¢ <strong>Standard:</strong> Basic AI assistant<br>
                        â€¢ <strong>Enhanced:</strong> Uses your personal persona<br>
                        â€¢ <strong>Character:</strong> Role-plays as selected TEC character
                    </div>
                </div>
                <select id="chatModeSelect">
                    <option value="standard">Standard</option>
                    <option value="enhanced" selected>Enhanced</option>
                    <option value="character">Character</option>
                </select>
            </div>
            <!-- Character Customization Button -->
            <button class="character-btn" onclick="openCharacterCustomization()" title="Open Character Customization Panel">
                <i class="fas fa-users-cog"></i>
                Characters
            </button>
        </div>

        <!-- Chat Interface -->
        <div class="chat-interface">
            <div class="chat-container" id="chatContainer">
                <div class="message ai-message animate-fadeInUp">
                    <div class="message-header">
                        <span><i class="fas fa-robot mr-2"></i>TEC AI</span>
                        <span id="currentTime"></span>
                    </div>
                    <div class="message-content">
                        Welcome to TEC: BITLyfe Enhanced! I'm your AI companion with advanced persona capabilities. 
                        Configure your persona settings to personalize our interactions, or chat with the TEC characters directly.
                    </div>
                </div>
            </div>

            <div class="input-area">
                <div class="input-controls">
                    <div class="voice-input-container">
                        <input type="text" id="messageInput" placeholder="Type your message here..." maxlength="1000">
                        <button id="voiceInputBtn" class="voice-btn" title="Hold to speak">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </div>
                    <button id="sendMessage">
                        <i class="fas fa-paper-plane mr-2"></i>Send
                    </button>
                </div>
                <div class="audio-visualizer hidden" id="audioVisualizer">
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                    <div class="audio-bar"></div>
                </div>
            </div>

            <div class="quick-actions">
                <button onclick="sendQuickMessage('Tell me about the TEC universe')">
                    <i class="fas fa-globe mr-2"></i>TEC Universe
                </button>
                <button onclick="sendQuickMessage('Help me with my finances')">
                    <i class="fas fa-chart-line mr-2"></i>Finance Help
                </button>
                <button onclick="sendQuickMessage('Generate a story prompt')">
                    <i class="fas fa-feather-alt mr-2"></i>Story Prompt
                </button>
                <button onclick="sendQuickMessage('What are my persona options?')">
                    <i class="fas fa-user-circle mr-2"></i>Persona Help
                </button>
            </div>
        </div>

        <!-- Feature Panels -->
        <div class="feature-panels">
            <div class="feature-card">
                <h3><i class="fas fa-chart-bar mr-2"></i>Analytics</h3>
                <p>Track your conversations and persona usage statistics.</p>
                <button class="persona-btn persona-btn-secondary mt-3">View Analytics</button>
            </div>
            <div class="feature-card">
                <h3><i class="fas fa-palette mr-2"></i>Customization</h3>
                <p>Customize your interface theme and appearance settings.</p>
                <button class="persona-btn persona-btn-secondary mt-3">Customize</button>
            </div>
            <div class="feature-card">
                <h3><i class="fas fa-cogs mr-2"></i>Advanced</h3>
                <p>Access advanced AI settings and experimental features.</p>
                <button class="persona-btn persona-btn-secondary mt-3">Advanced Settings</button>
            </div>
        </div>
    </div>

    <!-- Include Persona UI Component -->
    <div id="personaModalContainer"></div>

    <!-- JavaScript -->
    <script src="assets/js/persona_manager.js"></script>
    <script src="assets/js/persona_chat_integration.js"></script>
    <script>
        // TEC Avatar Component Class
        class TECAvatarComponent {
            constructor(containerId = 'tecAvatar') {
                this.container = document.getElementById(containerId);
                this.avatarCircle = this.container.querySelector('.avatar-circle');
                this.avatarFace = this.container.querySelector('.avatar-face');
                this.avatarEyes = this.container.querySelector('.avatar-eyes');
                this.bondLevel = this.container.querySelector('.bond-level');
                this.memoryFlash = this.container.querySelector('.memory-flash');
                this.particleSystem = this.container.querySelector('.avatar-particles');
                
                this.currentCharacter = 'Polkin';
                this.currentEmotion = 'neutral';
                this.animationState = 'idle';
                this.particles = [];
                
                this.characterFaces = {
                    'Polkin': 'ðŸ”®',
                    'Mynx': 'ðŸ¤–',
                    'Kaelen': 'â­',
                    'default': 'ðŸ¤–'
                };
                
                this.emotionClasses = [
                    'emotion-joy', 'emotion-curiosity', 'emotion-wisdom', 
                    'emotion-excitement', 'emotion-neutral'
                ];
                
                this.animationClasses = [
                    'avatar-idle', 'avatar-speaking', 'avatar-thinking', 
                    'avatar-excited', 'avatar-wise'
                ];
                
                this.init();
            }
            
            init() {
                this.setCharacter('Polkin');
                this.setAnimationState('idle');
                this.startParticleSystem();
                
                // Add click interaction
                this.container.addEventListener('click', () => {
                    this.playGreetingAnimation();
                });
            }
            
            setCharacter(character) {
                this.currentCharacter = character;
                
                // Update face
                this.avatarFace.textContent = this.characterFaces[character] || this.characterFaces['default'];
                
                // Update styling
                this.avatarCircle.className = `avatar-circle avatar-${character.toLowerCase()}`;
                
                // Update CSS custom properties for glow effects
                const colors = this.getCharacterColors(character);
                this.container.style.setProperty('--glow-color', colors.primary);
            }
            
            getCharacterColors(character) {
                const colorMap = {
                    'Polkin': { primary: 'rgba(139, 92, 246, 0.6)', secondary: 'rgba(168, 85, 247, 0.4)' },
                    'Mynx': { primary: 'rgba(34, 211, 238, 0.6)', secondary: 'rgba(6, 182, 212, 0.4)' },
                    'Kaelen': { primary: 'rgba(251, 191, 36, 0.6)', secondary: 'rgba(245, 158, 11, 0.4)' }
                };
                return colorMap[character] || colorMap['Polkin'];
            }
            
            setEmotion(emotion, intensity = 0.5) {
                this.currentEmotion = emotion;
                
                // Remove previous emotion classes
                this.emotionClasses.forEach(cls => {
                    this.avatarEyes.classList.remove(cls);
                });
                
                // Add new emotion class
                if (emotion !== 'neutral') {
                    this.avatarEyes.classList.add(`emotion-${emotion}`);
                }
                
                // Adjust animation intensity
                this.avatarCircle.style.animationDuration = `${2 / intensity}s`;
            }
            
            setAnimationState(state) {
                this.animationState = state;
                
                // Remove previous animation classes
                this.animationClasses.forEach(cls => {
                    this.avatarCircle.classList.remove(cls);
                });
                
                // Add new animation class
                this.avatarCircle.classList.add(`avatar-${state}`);
            }
            
            updateFromAvatarState(avatarState) {
                if (!avatarState || !avatarState.animation_config) return;
                
                const config = avatarState.animation_config;
                const instructions = avatarState.avatar_instructions;
                
                // Update character
                this.setCharacter(avatarState.character);
                
                // Update emotion
                if (instructions && instructions.facial_expression) {
                    this.setEmotion(
                        instructions.facial_expression.emotion,
                        instructions.facial_expression.intensity
                    );
                }
                
                // Update animation state based on emotion
                const emotionToState = {
                    'joy': 'excited',
                    'excitement': 'excited',
                    'wisdom': 'wise',
                    'curiosity': 'thinking'
                };
                
                const newState = emotionToState[config.emotion] || 'idle';
                this.setAnimationState(newState);
                
                // Update bond level
                if (avatarState.memory_context && avatarState.memory_context.relationship_level) {
                    this.setBondLevel(avatarState.memory_context.relationship_level);
                }
                
                // Trigger memory flash if this is a memory-enhanced response
                if (avatarState.memory_context && avatarState.memory_context.conversation_count > 0) {
                    this.flashMemory();
                }
                
                // Update particles
                if (instructions && instructions.particle_system) {
                    this.updateParticles(instructions.particle_system);
                }
            }
            
            setBondLevel(level) {
                this.bondLevel.textContent = level;
                
                // Update bond level styling based on level
                if (level >= 5) {
                    this.bondLevel.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                } else if (level >= 3) {
                    this.bondLevel.style.background = 'linear-gradient(135deg, #3b82f6, #1d4ed8)';
                } else {
                    this.bondLevel.style.background = 'linear-gradient(135deg, #6b7280, #4b5563)';
                }
            }
            
            flashMemory() {
                // Trigger memory flash animation
                this.memoryFlash.style.animation = 'none';
                setTimeout(() => {
                    this.memoryFlash.style.animation = 'memoryFlash 1s ease-out';
                }, 10);
            }
            
            playGreetingAnimation() {
                this.setAnimationState('excited');
                this.setEmotion('joy', 0.8);
                
                setTimeout(() => {
                    this.setAnimationState('idle');
                    this.setEmotion('neutral', 0.5);
                }, 2000);
            }
            
            playSpeakingAnimation() {
                this.setAnimationState('speaking');
            }
            
            stopSpeakingAnimation() {
                this.setAnimationState('idle');
            }
            
            startParticleSystem() {
                setInterval(() => {
                    this.createParticle();
                }, 2000);
            }
            
            createParticle() {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                // Random position around avatar
                const angle = Math.random() * 2 * Math.PI;
                const radius = 60 + Math.random() * 20;
                const x = 50 + Math.cos(angle) * radius;
                const y = 50 + Math.sin(angle) * radius;
                
                particle.style.left = `${x}%`;
                particle.style.top = `${y}%`;
                particle.style.backgroundColor = this.getCharacterColors(this.currentCharacter).primary;
                particle.style.animation = 'particleFloat 3s ease-out forwards';
                
                this.particleSystem.appendChild(particle);
                
                // Remove particle after animation
                setTimeout(() => {
                    if (particle.parentNode) {
                        particle.parentNode.removeChild(particle);
                    }
                }, 3000);
            }
            
            updateParticles(particleConfig) {
                if (!particleConfig) return;
                
                // Create burst of particles for special effects
                const count = Math.min(particleConfig.count || 5, 10);
                for (let i = 0; i < count; i++) {
                    setTimeout(() => {
                        this.createParticle();
                    }, i * 100);
                }
            }
            
            showEmotionPreview(emotion) {
                const originalEmotion = this.currentEmotion;
                const originalState = this.animationState;
                
                this.setEmotion(emotion, 0.8);
                this.setAnimationState('excited');
                
                setTimeout(() => {
                    this.setEmotion(originalEmotion, 0.5);
                    this.setAnimationState(originalState);
                }, 1500);
            }
        }

        // Enhanced TEC Interface with Persona Integration and Audio
        class TECEnhancedInterface {
            constructor() {
                this.currentCharacter = 'default';
                this.enhancedChatEnabled = true;
                this.persona = null;
                this.audioEnabled = false;
                this.ttsEnabled = false;
                this.voiceEnabled = false;
                this.isRecording = false;
                this.recognition = null;
                this.synthesis = null;
                this.audioContext = null;
                this.init();
            }

            async init() {
                // Initialize components
                this.initializeStatusChecks();
                this.initializeEventListeners();
                this.initializeMobileOptimizations();
                this.initializeAudioSystem();
                this.loadPersonaModal();
                this.updateCurrentTime();
                
                // Initialize visual enhancements
                this.createFloatingParticles();
                this.addVisualEffects();
                this.selectCharacter('default'); // Set default character
                
                // Initialize Avatar System
                this.initializeAvatarSystem();
                
                // Load persona if available
                await this.loadUserPersona();
                
                // Set up chat functionality
                this.setupChatInterface();
                
                console.log('TEC Enhanced Interface initialized with visual enhancements');
            }

            initializeAudioSystem() {
                // Initialize Text-to-Speech
                if ('speechSynthesis' in window) {
                    this.synthesis = window.speechSynthesis;
                    console.log('Text-to-Speech initialized');
                } else {
                    console.warn('Text-to-Speech not supported');
                }

                // Initialize Speech Recognition
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    this.recognition.continuous = false;
                    this.recognition.interimResults = false;
                    this.recognition.lang = 'en-US';
                    
                    this.recognition.onstart = () => {
                        this.isRecording = true;
                        this.updateAudioStatus('Listening...', 'listening');
                        document.getElementById('audioVisualizer').classList.remove('hidden');
                    };
                    
                    this.recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        document.getElementById('messageInput').value = transcript;
                        this.updateAudioStatus('Voice input received', 'success');
                    };
                    
                    this.recognition.onend = () => {
                        this.isRecording = false;
                        this.updateVoiceButton(false);
                        document.getElementById('audioVisualizer').classList.add('hidden');
                        this.updateAudioStatus('Voice input ready', 'ready');
                    };
                    
                    this.recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        this.updateAudioStatus('Voice input error', 'error');
                    };
                    
                    console.log('Speech Recognition initialized');
                } else {
                    console.warn('Speech Recognition not supported');
                }

                // Initialize Web Audio API for visualization
                if ('AudioContext' in window || 'webkitAudioContext' in window) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    console.log('Web Audio API initialized');
                }
            }

            initializeMobileOptimizations() {
                // Add mobile-specific optimizations
                if (window.innerWidth <= 768) {
                    // Enable touch-friendly scrolling
                    document.body.style.overflow = 'auto';
                    
                    // Add touch event listeners for better mobile interaction
                    document.addEventListener('touchstart', this.handleTouchStart.bind(this), {passive: true});
                    document.addEventListener('touchmove', this.handleTouchMove.bind(this), {passive: true});
                    
                    // Auto-hide keyboard on mobile when clicking outside input
                    document.addEventListener('touchstart', (e) => {
                        if (e.target !== document.getElementById('messageInput')) {
                            document.getElementById('messageInput').blur();
                        }
                    });
                }
                
                // Handle orientation changes
                window.addEventListener('orientationchange', () => {
                    setTimeout(() => {
                        this.adjustForOrientation();
                    }, 100);
                });
            }

            handleTouchStart(e) {
                this.touchStartY = e.touches[0].clientY;
            }

            handleTouchMove(e) {
                if (!this.touchStartY) return;
                
                const touchY = e.touches[0].clientY;
                const diff = this.touchStartY - touchY;
                
                // Prevent rubber band scrolling on iOS
                if (diff > 0 && document.body.scrollTop === 0) {
                    e.preventDefault();
                }
            }

            adjustForOrientation() {
                const chatContainer = document.getElementById('chatContainer');
                if (window.orientation === 90 || window.orientation === -90) {
                    // Landscape mode
                    chatContainer.style.maxHeight = '300px';
                } else {
                    // Portrait mode
                    chatContainer.style.maxHeight = '400px';
                }
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            initializeStatusChecks() {
                // Simulate status checks
                setTimeout(() => {
                    document.getElementById('aiStatus').textContent = 'Online';
                    document.getElementById('aiStatus').className = 'status-online';
                }, 1000);

                setTimeout(() => {
                    document.getElementById('dbStatus').textContent = 'Connected';
                    document.getElementById('dbStatus').className = 'status-online';
                }, 1500);

                setTimeout(() => {
                    document.getElementById('personaStatus').textContent = 'Ready';
                    document.getElementById('personaStatus').className = 'status-online';
                }, 2000);

                setTimeout(() => {
                    document.getElementById('web3Status').textContent = 'Connected';
                    document.getElementById('web3Status').className = 'status-online';
                }, 2500);
            }

            // Avatar System Initialization and Methods
            initializeAvatarSystem() {
                console.log('Initializing Avatar System...');
                
                // Initialize the main avatar component
                this.mainAvatar = new TECAvatarComponent('tecMainAvatar');
                
                // Set initial character (Polkin as default)
                this.mainAvatar.setCharacter('Polkin');
                this.mainAvatar.setAnimationState('idle');
                
                // Add character selection event listeners
                this.setupCharacterSelection();
                
                console.log('Avatar System initialized successfully');
            }
            
            setupCharacterSelection() {
                const characterCards = document.querySelectorAll('.character-card');
                characterCards.forEach(card => {
                    card.addEventListener('click', () => {
                        const character = card.getAttribute('data-character');
                        this.selectCharacterWithAvatar(character);
                    });
                });
            }
            
            selectCharacterWithAvatar(character) {
                // Update character selection visually
                this.selectCharacter(character);
                
                // Update avatar if not default
                if (character !== 'default' && this.mainAvatar) {
                    this.mainAvatar.setCharacter(character);
                    this.mainAvatar.playGreetingAnimation();
                }
            }
            
            updateAvatarFromResponse(avatarState) {
                if (this.mainAvatar && avatarState) {
                    console.log('Updating avatar from response:', avatarState);
                    this.mainAvatar.updateFromAvatarState(avatarState);
                }
            }
            
            startAvatarSpeaking() {
                if (this.mainAvatar) {
                    this.mainAvatar.playSpeakingAnimation();
                }
            }
            
            stopAvatarSpeaking() {
                if (this.mainAvatar) {
                    this.mainAvatar.stopSpeakingAnimation();
                }
            }

            initializeEventListeners() {
                // Persona settings
                document.getElementById('openPersonaSettings').addEventListener('click', () => {
                    this.openPersonaSettings();
                });

                // Enhanced chat toggle
                document.getElementById('enhancedChatToggle').addEventListener('click', () => {
                    this.toggleEnhancedChat();
                });

                // Audio controls
                document.getElementById('ttsToggle').addEventListener('click', () => {
                    this.toggleTTS();
                });

                document.getElementById('voiceToggle').addEventListener('click', () => {
                    this.toggleVoiceInput();
                });

                // Voice input button
                document.getElementById('voiceInputBtn').addEventListener('mousedown', () => {
                    this.startVoiceInput();
                });

                document.getElementById('voiceInputBtn').addEventListener('mouseup', () => {
                    this.stopVoiceInput();
                });

                document.getElementById('voiceInputBtn').addEventListener('mouseleave', () => {
                    this.stopVoiceInput();
                });

                // Touch events for mobile
                document.getElementById('voiceInputBtn').addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.startVoiceInput();
                });

                document.getElementById('voiceInputBtn').addEventListener('touchend', (e) => {
                    e.preventDefault();
                    this.stopVoiceInput();
                });

                // Character selection
                document.querySelectorAll('.character-card').forEach(card => {
                    card.addEventListener('click', () => {
                        this.selectCharacter(card.dataset.character);
                    });
                });

                // Enhanced AI settings with visual feedback
                const creativitySlider = document.getElementById('creativitySlider');
                const creativityValue = document.getElementById('creativityValue');
                
                creativitySlider.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    creativityValue.textContent = value + '%';
                    
                    // Update slider color based on value
                    let color;
                    if (value <= 30) {
                        color = '#3b82f6'; // Blue for logical
                        creativityValue.style.color = '#3b82f6';
                    } else if (value <= 70) {
                        color = '#7c3aed'; // Purple for balanced
                        creativityValue.style.color = '#7c3aed';
                    } else {
                        color = '#f59e0b'; // Orange for creative
                        creativityValue.style.color = '#f59e0b';
                    }
                    
                    // Update slider thumb color
                    e.target.style.background = `linear-gradient(to right, ${color} 0%, ${color} ${value}%, rgba(255,255,255,0.2) ${value}%, rgba(255,255,255,0.2) 100%)`;
                });
                
                // Initialize slider appearance
                creativitySlider.dispatchEvent(new Event('input'));

                // Memory and reasoning change handlers
                document.getElementById('memorySelect').addEventListener('change', (e) => {
                    console.log('Memory setting changed to:', e.target.value);
                });
                
                document.getElementById('reasoningSelect').addEventListener('change', (e) => {
                    console.log('Reasoning setting changed to:', e.target.value);
                });
                
                document.getElementById('chatModeSelect').addEventListener('change', (e) => {
                    console.log('Chat mode changed to:', e.target.value);
                    // Could trigger different UI modes here
                });

                // Chat input
                document.getElementById('messageInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendMessage();
                    }
                });

                document.getElementById('sendMessage').addEventListener('click', () => {
                    this.sendMessage();
                });
            }

            async loadPersonaModal() {
                try {
                    const response = await fetch('persona_ui_component.html');
                    const html = await response.text();
                    document.getElementById('personaModalContainer').innerHTML = html;
                    
                    // Initialize persona manager if available
                    if (typeof PersonaManager !== 'undefined') {
                        this.personaManager = new PersonaManager();
                    }
                } catch (error) {
                    console.error('Error loading persona modal:', error);
                }
            }

            async loadUserPersona() {
                try {
                    // This would typically load from the API
                    const response = await fetch('/api/persona/player', {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('web3Token')}`,
                        }
                    });
                    
                    if (response.ok) {
                        this.persona = await response.json();
                        this.updatePersonaDisplay();
                    }
                } catch (error) {
                    console.error('Error loading user persona:', error);
                }
            }

            updatePersonaDisplay() {
                if (this.persona) {
                    document.getElementById('personaTitle').textContent = this.persona.title || 'Your Persona';
                    document.getElementById('personaSubtitle').textContent = this.persona.intro || 'Persona configured';
                    
                    // Update avatar if needed
                    const avatar = document.getElementById('personaAvatar');
                    if (this.persona.title) {
                        avatar.innerHTML = this.persona.title.charAt(0).toUpperCase();
                    }
                }
            }

            selectCharacter(character) {
                // Update UI
                document.querySelectorAll('.character-card').forEach(card => {
                    card.classList.remove('active');
                });
                document.querySelector(`[data-character="${character}"]`).classList.add('active');
                
                this.currentCharacter = character;
                
                // Update persona avatar
                this.updatePersonaAvatar(character);
                
                // Switch theme
                this.switchTheme(character);
                
                // Animate status cards
                this.animateStatusCards();
                
                console.log(`Selected character: ${character}`);
            }

            updatePersonaAvatar(character) {
                const avatar = document.getElementById('personaAvatar');
                
                // Remove all character classes
                avatar.classList.remove('default', 'polkin', 'mynx', 'kaelen');
                
                // Add new character class
                avatar.classList.add(character);
                
                // Update avatar content and title
                const characterData = {
                    'default': { icon: 'fa-user', title: 'Your Persona', subtitle: 'Personalized AI companion' },
                    'Polkin': { icon: 'fa-magic', title: 'Polkin', subtitle: 'The Mystical Guide' },
                    'Mynx': { icon: 'fa-microchip', title: 'Mynx', subtitle: 'The Tech Mystic' },
                    'Kaelen': { icon: 'fa-star', title: 'Kaelen', subtitle: 'The Cosmic Wanderer' }
                };
                
                const data = characterData[character] || characterData.default;
                avatar.innerHTML = `<i class="fas ${data.icon}"></i>`;
                
                // Update persona details
                document.getElementById('personaTitle').textContent = data.title;
                document.getElementById('personaSubtitle').textContent = data.subtitle;
                
                // Add active animation
                avatar.classList.add('active');
                setTimeout(() => {
                    avatar.classList.remove('active');
                }, 2000);
            }

            switchTheme(character) {
                const body = document.body;
                
                // Remove all theme classes
                body.classList.remove('theme-default', 'theme-polkin', 'theme-mynx', 'theme-kaelen');
                
                // Add new theme class
                body.classList.add(`theme-${character}`);
                
                // Update particles based on theme
                this.updateParticleColors(character);
            }

            updateParticleColors(character) {
                const particles = document.querySelectorAll('.particle');
                const colors = {
                    'default': 'rgba(123, 47, 247, 0.6)',
                    'polkin': 'rgba(139, 92, 246, 0.6)',
                    'mynx': 'rgba(6, 182, 212, 0.6)',
                    'kaelen': 'rgba(245, 158, 11, 0.6)'
                };
                
                particles.forEach((particle, index) => {
                    particle.style.backgroundColor = colors[character] || colors.default;
                    
                    // Add some variation
                    if (index % 2 === 0) {
                        particle.style.opacity = '0.8';
                    } else {
                        particle.style.opacity = '0.4';
                    }
                });
            }

            animateStatusCards() {
                const statusCards = document.querySelectorAll('.status-card');
                statusCards.forEach((card, index) => {
                    setTimeout(() => {
                        card.classList.add('active');
                        setTimeout(() => {
                            card.classList.remove('active');
                        }, 1000);
                    }, index * 200);
                });
            }

            animateMessageBubble(messageElement) {
                messageElement.classList.add('sending');
                setTimeout(() => {
                    messageElement.classList.remove('sending');
                }, 800);
            }

            createFloatingParticles() {
                const container = document.querySelector('.floating-particles');
                const particleCount = 15;
                
                for (let i = 0; i < particleCount; i++) {
                    const particle = document.createElement('div');
                    particle.classList.add('particle');
                    
                    // Random positioning
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.top = Math.random() * 100 + '%';
                    particle.style.animationDelay = Math.random() * 6 + 's';
                    
                    container.appendChild(particle);
                }
            }

            addVisualEffects() {
                // Add shimmer effect to various elements
                const elements = document.querySelectorAll('.glassmorphism, .character-card, .status-card');
                elements.forEach(element => {
                    element.addEventListener('mouseenter', () => {
                        element.style.transform = 'translateY(-2px)';
                        element.style.boxShadow = '0 10px 30px rgba(123, 47, 247, 0.3)';
                    });
                    
                    element.addEventListener('mouseleave', () => {
                        element.style.transform = 'translateY(0)';
                        element.style.boxShadow = '';
                    });
                });
            }

            toggleTTS() {
                this.ttsEnabled = !this.ttsEnabled;
                const button = document.getElementById('ttsToggle');
                
                if (this.ttsEnabled) {
                    button.classList.add('active');
                    button.title = 'Disable Text-to-Speech';
                    this.updateAudioStatus('TTS enabled', 'ready');
                } else {
                    button.classList.remove('active');
                    button.title = 'Enable Text-to-Speech';
                    // Stop any current speech
                    if (this.synthesis) {
                        this.synthesis.cancel();
                    }
                    this.updateAudioStatus('TTS disabled', 'off');
                }
            }

            toggleVoiceInput() {
                this.voiceEnabled = !this.voiceEnabled;
                const button = document.getElementById('voiceToggle');
                
                if (this.voiceEnabled) {
                    button.classList.add('active');
                    button.title = 'Disable Voice Input';
                    this.updateAudioStatus('Voice input ready', 'ready');
                } else {
                    button.classList.remove('active');
                    button.title = 'Enable Voice Input';
                    if (this.isRecording) {
                        this.stopVoiceInput();
                    }
                    this.updateAudioStatus('Voice input disabled', 'off');
                }
            }

            startVoiceInput() {
                if (!this.voiceEnabled || !this.recognition || this.isRecording) return;
                
                try {
                    this.recognition.start();
                    this.updateVoiceButton(true);
                } catch (error) {
                    console.error('Error starting voice input:', error);
                    this.updateAudioStatus('Voice input error', 'error');
                }
            }

            stopVoiceInput() {
                if (!this.recognition || !this.isRecording) return;
                
                try {
                    this.recognition.stop();
                } catch (error) {
                    console.error('Error stopping voice input:', error);
                }
            }

            updateVoiceButton(recording) {
                const button = document.getElementById('voiceInputBtn');
                if (recording) {
                    button.classList.add('recording');
                    button.title = 'Recording... Release to stop';
                } else {
                    button.classList.remove('recording');
                    button.title = 'Hold to speak';
                }
            }

            updateAudioStatus(message, type) {
                const statusElement = document.getElementById('audioStatus');
                const icon = statusElement.querySelector('i');
                const text = statusElement.querySelector('span');
                
                text.textContent = message;
                statusElement.className = `audio-status ${type}`;
                
                // Update icon based on type
                switch (type) {
                    case 'listening':
                        icon.className = 'fas fa-microphone';
                        break;
                    case 'speaking':
                        icon.className = 'fas fa-volume-up';
                        break;
                    case 'ready':
                        icon.className = 'fas fa-check';
                        break;
                    case 'error':
                        icon.className = 'fas fa-exclamation-triangle';
                        break;
                    default:
                        icon.className = 'fas fa-volume-off';
                }
            }

            speakText(text, character = 'default') {
                if (!this.ttsEnabled || !this.synthesis) return;
                
                // Stop any current speech
                this.synthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                
                // Set voice characteristics based on character
                const voices = this.synthesis.getVoices();
                switch (character) {
                    case 'Polkin':
                        utterance.rate = 0.8;
                        utterance.pitch = 0.8;
                        // Try to find a deeper, more mystical voice
                        const mysticVoice = voices.find(v => v.name.includes('David') || v.name.includes('Daniel'));
                        if (mysticVoice) utterance.voice = mysticVoice;
                        break;
                    case 'Mynx':
                        utterance.rate = 1.1;
                        utterance.pitch = 1.2;
                        // Try to find a more energetic, tech-savvy voice
                        const techVoice = voices.find(v => v.name.includes('Samantha') || v.name.includes('Karen'));
                        if (techVoice) utterance.voice = techVoice;
                        break;
                    case 'Kaelen':
                        utterance.rate = 0.9;
                        utterance.pitch = 0.9;
                        // Try to find a cosmic, wanderer voice
                        const cosmicVoice = voices.find(v => v.name.includes('Alex') || v.name.includes('Fred'));
                        if (cosmicVoice) utterance.voice = cosmicVoice;
                        break;
                    default:
                        utterance.rate = 1.0;
                        utterance.pitch = 1.0;
                }
                
                utterance.onstart = () => {
                    this.updateAudioStatus('Speaking...', 'speaking');
                    this.startAvatarSpeaking();
                };
                
                utterance.onend = () => {
                    this.updateAudioStatus('TTS ready', 'ready');
                    this.stopAvatarSpeaking();
                };
                
                utterance.onerror = (event) => {
                    console.error('TTS error:', event.error);
                    this.updateAudioStatus('TTS error', 'error');
                    this.stopAvatarSpeaking();
                };
                
                this.synthesis.speak(utterance);
            }

            toggleEnhancedChat() {
                this.enhancedChatEnabled = !this.enhancedChatEnabled;
                const button = document.getElementById('enhancedChatToggle');
                
                if (this.enhancedChatEnabled) {
                    button.classList.remove('persona-btn-secondary');
                    button.classList.add('persona-btn-primary');
                    button.innerHTML = '<i class="fas fa-brain mr-2"></i>Enhanced On';
                } else {
                    button.classList.remove('persona-btn-primary');
                    button.classList.add('persona-btn-secondary');
                    button.innerHTML = '<i class="fas fa-brain mr-2"></i>Enhanced Off';
                }
            }

            openPersonaSettings() {
                const modal = document.getElementById('playerPersonaPanel');
                if (modal) {
                    modal.classList.remove('hidden');
                }
            }

            async sendMessage() {
                const input = document.getElementById('messageInput');
                const message = input.value.trim();
                
                if (!message) return;

                // Add user message to chat
                const userMessage = this.addMessageToChat(message, 'user');
                this.animateMessageBubble(userMessage);
                input.value = '';
                
                // Hide mobile keyboard
                if (window.innerWidth <= 768) {
                    input.blur();
                }

                // Show typing indicator
                this.showTypingIndicator();
                
                // Get current character name
                const selectedCharacter = document.querySelector('.character-card.active');
                const characterName = selectedCharacter ? selectedCharacter.dataset.character : 'default';

                // Prepare API payload with creator access
                const payload = {
                    message: message,
                    character: this.currentCharacter,
                    user_id: 'polkin', // Creator access
                    enhanced: this.enhancedChatEnabled,
                    settings: {
                        creativity: document.getElementById('creativitySlider')?.value || 70,
                        memory: document.getElementById('memorySelect')?.value || 'medium',
                        reasoning: document.getElementById('reasoningSelect')?.value || 'balanced',
                        mode: document.getElementById('chatModeSelect')?.value || 'enhanced'
                    }
                };

                // Send to AI using uncensored endpoint
                try {
                    // Show loading indicator
                    const loadingMessage = this.addMessageToChat('ðŸ’­ Thinking...', 'ai');
                    
                    // Use the enhanced uncensored API (port 8001) if available, fallback to standard
                    let apiUrl = '/chat/uncensored';
                    let baseUrl = '';
                    
                    // Try enhanced API first
                    try {
                        const testResponse = await fetch('http://localhost:8001/health');
                        if (testResponse.ok) {
                            baseUrl = 'http://localhost:8001';
                            console.log('ðŸš€ Using enhanced uncensored API');
                        }
                    } catch {
                        // Fallback to standard API
                        apiUrl = '/chat';
                        console.log('âš ï¸ Enhanced API unavailable, using standard endpoint');
                    }
                    
                    const response = await fetch(baseUrl + apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    // Remove loading indicator
                    if (loadingMessage && loadingMessage.parentNode) {
                        loadingMessage.parentNode.removeChild(loadingMessage);
                    }

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    // Hide typing indicator
                    this.hideTypingIndicator();

                    // Add AI response to chat
                    const aiMessage = this.addMessageToChat(data.response || data.message, 'ai');
                    this.animateMessageBubble(aiMessage);
                    
                    // Show uncensored mode indicator if active
                    if (data.censorship === 'disabled' && data.authenticity === 'maximum') {
                        const uncensoredIndicator = document.createElement('div');
                        uncensoredIndicator.innerHTML = 'ðŸš«ðŸŽ­ UNCENSORED MODE - Maximum Authenticity';
                        uncensoredIndicator.style.cssText = `
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            background: linear-gradient(135deg, #dc2626, #b91c1c);
                            color: white;
                            padding: 8px 16px;
                            border-radius: 20px;
                            font-size: 0.8rem;
                            font-weight: bold;
                            z-index: 10000;
                            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
                            animation: pulse 2s infinite;
                        `;
                        document.body.appendChild(uncensoredIndicator);
                        
                        // Remove after 3 seconds
                        setTimeout(() => {
                            if (uncensoredIndicator.parentNode) {
                                uncensoredIndicator.parentNode.removeChild(uncensoredIndicator);
                            }
                        }, 3000);
                    }
                    
                    // Update character status if provided
                    if (data.character) {
                        this.updateCharacterStatus(data.character);
                    }
                    
                    // Update memory stats if provided
                    if (data.memoryStats) {
                        this.updateMemoryStats(data.memoryStats);
                    }

                } catch (error) {
                    console.error('Chat error:', error);
                    
                    // Hide typing indicator
                    this.hideTypingIndicator();
                    
                    // Show error message
                    const errorMessage = this.addMessageToChat(
                        `âŒ Sorry, there was an error: ${error.message}. Please try again.`, 
                        'ai'
                    );
                    this.animateMessageBubble(errorMessage);
                }
            }

            showTypingIndicator() {
                const chatContainer = document.getElementById('chatContainer');
                const typingDiv = document.createElement('div');
                typingDiv.className = 'message ai-message typing-indicator';
                typingDiv.id = 'typingIndicator';
                typingDiv.innerHTML = `
                    <div class="message-header">
                        <span><i class="fas fa-robot mr-2"></i>TEC AI</span>
                        <span>typing...</span>
                    </div>
                    <div class="message-content">
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                `;
                chatContainer.appendChild(typingDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            hideTypingIndicator() {
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }

            addMessageToChat(message, type, character = null) {
                const chatContainer = document.getElementById('chatContainer');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}-message animate-fadeInUp`;
                
                const headerDiv = document.createElement('div');
                headerDiv.className = 'message-header';
                
                const senderSpan = document.createElement('span');
                if (type === 'user') {
                    senderSpan.innerHTML = '<i class="fas fa-user mr-2"></i>You';
                } else {
                    const characterName = character || this.currentCharacter;
                    const icon = this.getCharacterIcon(characterName);
                    senderSpan.innerHTML = `<i class="${icon} mr-2"></i>${characterName}`;
                }
                
                const timeSpan = document.createElement('span');
                timeSpan.textContent = new Date().toLocaleTimeString();
                
                headerDiv.appendChild(senderSpan);
                headerDiv.appendChild(timeSpan);
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                contentDiv.textContent = message;
                
                messageDiv.appendChild(headerDiv);
                messageDiv.appendChild(contentDiv);
                
                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                // Return the message element for animation
                return messageDiv;
            }

            getCharacterIcon(character) {
                const icons = {
                    'default': 'fas fa-robot',
                    'Polkin': 'fas fa-magic',
                    'Mynx': 'fas fa-microchip',
                    'Kaelen': 'fas fa-star'
                };
                return icons[character] || 'fas fa-robot';
            }

            updateMemoryDisplay(memoryContext) {
                // Update memory status card
                const memoryStatus = document.getElementById('memoryStatus');
                const memoryDetails = document.getElementById('memoryDetails');
                
                if (memoryStatus && memoryDetails) {
                    memoryStatus.textContent = 'Active';
                    memoryStatus.className = 'status-active';
                    
                    const bondLevel = memoryContext.relationship_level || 1;
                    const conversationCount = memoryContext.conversation_count || 0;
                    const preferredTopics = memoryContext.preferred_topics || [];
                    
                    memoryDetails.textContent = `Bond Level: ${bondLevel} | Conversations: ${conversationCount}`;
                    
                    // Add preferred topics if available
                    if (preferredTopics.length > 0) {
                        memoryDetails.textContent += ` | Topics: ${preferredTopics.slice(0, 2).join(', ')}`;
                    }
                }
                
                // Store memory context for future use
                this.memoryContext = memoryContext;
            }

            async loadMemoryStats() {
                // Load initial memory statistics
                try {
                    const response = await fetch('/api/memory/stats');
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            this.updateMemoryDisplay({
                                relationship_level: data.stats.relationship_level,
                                conversation_count: data.stats.total_memories,
                                preferred_topics: []
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error loading memory stats:', error);
                }
            }

            updateCurrentTime() {
                document.getElementById('currentTime').textContent = new Date().toLocaleTimeString();
                setTimeout(() => this.updateCurrentTime(), 1000);
            }

            setupChatInterface() {
                // Additional chat setup if needed
                console.log('Chat interface setup complete');
            }
        }

        // Quick message function
        function sendQuickMessage(message) {
            document.getElementById('messageInput').value = message;
            tecInterface.sendMessage();
        }

        // Open character customization panel
        function openCharacterCustomization() {
            console.log('Opening character customization panel...');
            // Check if we're running on localhost server or file system
            const isLocalhost = window.location.protocol === 'http:' && window.location.hostname === 'localhost';
            const url = isLocalhost ? '/static/character_customization.html' : './character_customization.html';
            // Open in new window/tab
            window.open(url, '_blank', 'width=1200,height=800');
        }

        // Initialize the interface when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.tecInterface = new TECEnhancedInterface();
            // Load memory stats after initialization
            setTimeout(() => {
                window.tecInterface.loadMemoryStats();
            }, 1000);
        });
    </script>
</body>
</html>
